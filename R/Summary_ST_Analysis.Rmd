---
title: "Share Table Analysis with DR"
author: "Gustavo Reyes"
date: "1/11/2021"
output: html_document
---
Share Table Analysis


#1Run with Share Table on. 
```{r}
Func_Rep_DR<-function(DF_DR_Analysis){
  DF_DR_Analysis$Infection<-apply(DF_DR_Analysis,1,Func_DR_Infection)
  Number_Inf_Fr<-sum(DF_DR_Analysis$Infection==TRUE)
  #
  DF_DR_Analysis$Illness<-apply(DF_DR_Analysis,1,Func_DR_Illness)
  Number_Ill_Fr<-sum(DF_DR_Analysis$Illness==TRUE)
  l<-list("infection"=Number_Inf_Fr, "Illness"=Number_Ill_Fr )
  return(l)
}
```


```{r}
#Setting Working Directory
setwd("C:/Users/gareyes3/Documents/GitHub/Share-Table-QMRA/R") 
#setwd("G:/Share Table QMRA/Share-Table-QMRA/R")
```

```{r}
#Opening Libary and Inputs
source("Util_Library.R")
```

```{r}
#Inputs and Source Files
# Source Files ------------------------------------------------------------

#Inputs
source("Input_Static.R")
source("Input_Functions.R")
source("Util_DFFunctions.R")
source("Util_DFWeekCreation.R")
source("Util_Counter&Lists.R")
#Functions
source("Util_Functions.R")
source("Util_CCFunctions2.R")
source("Util_VisualFunctions.R")

```

```{r warning=TRUE}
#Running Loop First:
start_time<-Sys.time()
source("Main_Loops2.R")
```

```{r}
#Summary DFs for Future. 

#Creating Data Frame of Consumed Items for all the products

  #Fruit

#1. Start from here
Individual_Analysis_Fr<-bind_rows(List_Sens_Fr)
Individual_Analysis_Fr_CopON<-bind_rows(List_Sens_Fr)

#Adding Type Column
Individual_Analysis_Fr$Type<-"Fruit"

#2. find the dupplicates
#this step filters replicated based on the ID
Individual_Analysis_Fr<-Individual_Analysis_Fr %>% 
  group_by(ID) %>% 
  filter(TotServices==max(TotServices))%>%
  filter(Location=="Consumed")%>%
  select(ID,Type,ConsumedBy,Contamination, ContConsumed, Infection,Illness,week)
#3
ST_ON_Analysis<-Individual_Analysis_Fr

```


#Running Model Now With ST Off

```{r}
#Inputs and Source Files
# Source Files ------------------------------------------------------------


#Inputs
source("Input_Static.R")
source("Input_Functions.R")
source("Util_DFFunctions.R")
source("Util_DFWeekCreation.R")
source("Util_Counter&Lists.R")
#Functions
source("Util_Functions.R")
source("Util_CCFunctions2.R")
source("Util_VisualFunctions.R")

#Share Table Toggle 
  
  #Include Share Table:
  Share_Table_YN<-0
  #NOTE: Turn off Re-Sharing and -ST to reservice too (next section)

# Re-Sharing, Re-Service 

  #Share Table to Service line after every Day # note turn in 1 if ST on
  STtoReservice_YN<-0
  #Re-Sharing of Share table items after every service # note turn in 1 is ST on
  Resharing_YN<-0

```

```{r warning=TRUE}
#Running Loop First:
start_time<-Sys.time()
source("Main_Loops2.R")
```

```{r}
#Summary DFs for Future. 

#Creating Data Frame of Consumed Items for all the products

  #Fruit

#1. Start from here
Individual_Analysis_Fr<-bind_rows(List_Sens_Fr)
Individual_Analysis_Fr_CopOFF<-bind_rows(List_Sens_Fr)

#Adding Type Column
Individual_Analysis_Fr$Type<-"Fruit"

#2. find the dupplicates
#this step filters replicated based on the ID
Individual_Analysis_Fr<-Individual_Analysis_Fr %>% 
  group_by(ID) %>% 
  filter(TotServices==max(TotServices))%>%
  filter(Location=="Consumed")%>%
  select(ID,Type,ConsumedBy,Contamination, ContConsumed, Infection,Illness,week)
#3
ST_OFF_Analysis<-Individual_Analysis_Fr

```

#Dose Response Model
#ST ON

```{r}
#ST ON
ST_ON_Analysis_Copy<-ST_ON_Analysis


df1<-ST_ON_Analysis_Copy %>% 
  group_by(week) %>% 
  summarize(count=n())
df1$week<-paste("Week",df1$week)



 ST_ON_Analysis<-ST_ON_Analysis%>%
      group_by(ConsumedBy)%>%
      summarise(Contamination = sum(Contamination))

    ST_ON_Analysis$week <- substr(ST_ON_Analysis$ConsumedBy, 1, 3) 
    ST_ON_Analysis$Infection<-as.logical("")
    ST_ON_Analysis$Illness<-as.logical("")
    
#Analysis For weekly Dose Response ON

Reps_DR<-100

List_week_DR<-split(x=ST_ON_Analysis,f=ST_ON_Analysis$week)
lista<-replicate(Reps_DR,lapply(List_week_DR,Func_Rep_DR),simplify = FALSE)
list_Df_Rep<-lapply(lista, Func_List2DF)
list_Df_Rep<-lapply(list_Df_Rep, setNames, c("Infections", "Illness"))
list_Df_Rep<-lapply(list_Df_Rep,bind_rows)
list_Df_Rep<-bind_cols(list_Df_Rep)


df_inf_Week_ON = list_Df_Rep[,seq(1, ncol(list_Df_Rep), 2) ]
df_ill_Week_ON = list_Df_Rep[,seq(2, ncol(list_Df_Rep), 2) ]

df_inf_Week_ON<-as.data.frame(t(df_inf_Week_ON))
df_ill_Week_ON<-as.data.frame(t(df_ill_Week_ON))

rownames(df_inf_Week_ON)<-paste("Rep",1:Reps_DR)
rownames(df_ill_Week_ON)<-paste("Rep",1:Reps_DR)
colnames(df_inf_Week_ON)<-paste("Week",1:Sens_Iterations)
colnames(df_ill_Week_ON)<-paste("Week",1:Sens_Iterations)    

```


#Dose Response Model
#ST Off

```{r}
#ST OFF
ST_OFF_Analysis_Copy<-ST_OFF_Analysis

 ST_OFF_Analysis<-ST_OFF_Analysis%>%
      group_by(ConsumedBy)%>%
      summarise(Contamination = sum(Contamination))

    ST_OFF_Analysis$week <- substr(ST_OFF_Analysis$ConsumedBy, 1, 3)
    ST_OFF_Analysis$Infection<-as.logical("")
    ST_OFF_Analysis$Illness<-as.logical("")
    
#Analysis For weekly Dose Response ON

Reps_DR<-100

List_week_DR<-split(x=ST_OFF_Analysis,f=ST_OFF_Analysis$week)
lista<-replicate(Reps_DR,lapply(List_week_DR,Func_Rep_DR),simplify = FALSE)
list_Df_Rep<-lapply(lista, Func_List2DF)
list_Df_Rep<-lapply(list_Df_Rep, setNames, c("Infections", "Illness"))
list_Df_Rep<-lapply(list_Df_Rep,bind_rows)
list_Df_Rep<-bind_cols(list_Df_Rep)


df_inf_Week_OFF = list_Df_Rep[,seq(1, ncol(list_Df_Rep), 2) ]
df_ill_Week_OFF = list_Df_Rep[,seq(2, ncol(list_Df_Rep), 2) ]

df_inf_Week_OFF<-as.data.frame(t(df_inf_Week_OFF))
df_ill_Week_OFF<-as.data.frame(t(df_ill_Week_OFF))

rownames(df_inf_Week_OFF)<-paste("Rep",1:Reps_DR)
rownames(df_ill_Week_OFF)<-paste("Rep",1:Reps_DR)
colnames(df_inf_Week_OFF)<-paste("Week",1:Sens_Iterations)
colnames(df_ill_Week_OFF)<-paste("Week",1:Sens_Iterations) 


```

```{r}
df_inf_Week_ON_Box <- melt(df_inf_Week_ON, measure.var = paste("Week",1:Sens_Iterations))

df_inf_Week_ON_Box_Prev<-merge(df_inf_Week_ON_Box, df1, by.x='variable', by.y='week')
df_inf_Week_ON_Box_Prev$Prev<-df_inf_Week_ON_Box_Prev$value/df_inf_Week_ON_Box_Prev$count

ggplot(df_inf_Week_ON_Box_Prev, aes(x = variable, y = Prev)) + 
  geom_boxplot() + 
  theme_bw()+
  ylab("# Infected Student")+
  xlab("Week #") +
  ggtitle("ST ON: Dose Response 100 replicates, Prevalence of Infected Students by week")+ 
  theme(plot.title = element_text(hjust = 0.5))

df_ill_Week_ON_Box <- melt(df_ill_Week_ON, measure.var = paste("Week",1:Sens_Iterations))
df_ill_Week_ON_Box_Prev<-merge(df_ill_Week_ON_Box, df1, by.x='variable', by.y='week')
df_ill_Week_ON_Box_Prev$Prev<-df_ill_Week_ON_Box_Prev$value/df_ill_Week_ON_Box_Prev$count

ggplot(df_ill_Week_ON_Box_Prev, aes(x = variable, y = Prev)) + 
  geom_boxplot() + 
  theme_bw()+
  ylab("Prevalence of Ill Students")+
  xlab("Week #")+
  ggtitle("ST ON: Dose Response 100 replicates, Prevalence of Ill Students by week")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}



df_inf_Week_OFF_Box <- melt(df_inf_Week_OFF, measure.var = paste("Week",1:Sens_Iterations))

df_inf_Week_OFF_Box_Prev<-merge(df_inf_Week_OFF_Box, df1, by.x='variable', by.y='week')
df_inf_Week_OFF_Box_Prev$Prev<-df_inf_Week_OFF_Box_Prev$value/df_inf_Week_OFF_Box_Prev$count

ggplot(df_inf_Week_OFF_Box_Prev, aes(x = variable, y = Prev)) + 
  geom_boxplot() + 
  theme_bw()+
  ylab("# Infected Student")+
  xlab("Week #") +
  ggtitle("Weekly Dose Response Distribution 100 replicates Infected Students")+ 
  theme(plot.title = element_text(hjust = 0.5))

df_ill_Week_OFF_Box <- melt(df_ill_Week_OFF, measure.var = paste("Week",1:Sens_Iterations))

df_ill_Week_OFF_Box_Prev<-merge(df_ill_Week_OFF_Box, df1, by.x='variable', by.y='week')
df_ill_Week_OFF_Box_Prev$Prev<-df_ill_Week_OFF_Box_Prev$value/df_ill_Week_OFF_Box_Prev$count

ggplot(df_ill_Week_OFF_Box_Prev, aes(x = variable, y = Prev)) + 
  geom_boxplot() + 
  theme_bw()+
  ylab("# Ill Student")+
  xlab("Week #")+
  ggtitle("Weekly Dose Response Distribution, 100 replicates: Ill Students")+ 
  theme(plot.title = element_text(hjust = 0.5))
```
#Boxplot Together
```{r}
#Infected
df_inf_Week_ON_Box_Prev$Int<-"on"
df_inf_Week_OFF_Box_Prev$Int<-"off"

df_inf_Week_Tog_Box<-bind_rows(df_inf_Week_ON_Box_Prev,df_inf_Week_OFF_Box_Prev)

ggplot(df_inf_Week_Tog_Box, aes(x = variable, y = Prev, fill=Int)) + 
  geom_boxplot() + 
  theme_bw()+
  ylab("Prevalence of Infected Student")+
  xlab("Week #") +
  ggtitle("ST Status: Compaison Weekly Dose Response Distribution: Prevalence Infected Students")+ 
  theme(plot.title = element_text(hjust = 0.5))+
  labs(fill = "ST Status")

#Ill

df_ill_Week_ON_Box_Prev$Int<-"on"
df_ill_Week_OFF_Box_Prev$Int<-"off"

df_ill_Week_Tog_Box<-bind_rows(df_ill_Week_ON_Box_Prev,df_ill_Week_OFF_Box_Prev)

Ill_Prev_Comb<-ggplot(df_ill_Week_Tog_Box, aes(x = variable, y = Prev, fill=Int)) + 
  geom_boxplot() + 
  theme_bw()+
  ylab("Prevalence of Ill Students")+
  xlab("Week #") +
  ggtitle("ST Status: Compaison Weekly Dose Response Distribution: Prevalence Ill Students")+ 
  theme(plot.title = element_text(hjust = 0.5))+
  labs(fill = "ST Status")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggsave(filename = "Ill_Prev_Comb.png", path = "Dose Response",width = 40,height = 10,)

```

#Ribon Together
```{r}

Ribon_Ill_OFF<-df_ill_Week_OFF_Box_Prev%>%
  group_by(variable)%>%
  summarise(PrevMed= median(Prev),Prev975= quantile(Prev,.975),Prev025= quantile(Prev,.025))%>%
  mutate(Type = "Off")

df_ill_Week_ON_Box_Prev<-df_ill_Week_ON_Box_Prev[,-2]

Ribon_Ill_ON<-df_ill_Week_ON_Box_Prev%>%
  group_by(variable)%>%
  summarise(PrevMed= median(Prev),Prev975= quantile(Prev,.975),Prev025= quantile(Prev,.025))%>%
  mutate(Type = "on")

Ribbon_Ill_DF<-bind_rows(Ribon_Ill_OFF,Ribon_Ill_ON)

Ribbon_Ill<-ggplot(Ribbon_Ill_DF, aes(x = variable, y = PrevMed, group = Type)) + 
  geom_ribbon(aes(ymin = Prev975, ymax = Prev025, fill=Type), alpha=0.3 )+ 
  geom_point(aes(x = variable, y = PrevMed, color = Type))+
  geom_line(aes(x= variable, y= PrevMed,color = Type), size = .5) +   
  labs(x = "Week #", y = "Prevalence of Ill Student per Week") +
  scale_fill_manual(name = '2.5th-97.5th Percentile', values = c("dodgerblue1", "tomato4", "seagreen1"))+ 
  scale_color_manual(name = 'Median', values = c("dodgerblue1", "tomato4", "seagreen1"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggsave(filename = "Ribbon_Ill.png", path = "Dose Response",width = 20,height = 7,)


```


#Comparison of amounts consumed. 
```{r}
ST_OFF_Analysis_Con<-Individual_Analysis_Fr_CopOFF
ST_ON_Analysis_Con<-Individual_Analysis_Fr_CopON

ST_OFF_Analysis_Con$Type<-"off"
ST_ON_Analysis_Con$Type<-"on"

ST_Comb_Analysis_Con<-bind_rows(ST_OFF_Analysis_Con,ST_ON_Analysis_Con)

ggplot(data =ST_Comb_Analysis_Con, aes(x = Type,fill=Location)  )+
  geom_bar()+
  geom_text(stat = "count",aes(label=..count..),position = position_stack(vjust = .5))

```


#Plots Creation for Exposure
```{r}
#Histogram Exposure
ST_ON_Analysis_Log<-ST_ON_Analysis
ST_ON_Analysis_Log$Contamination[ST_ON_Analysis_Log$Contamination==0]<-(.99)
ST_ON_Analysis_Log$Log<-log10(ST_ON_Analysis_Log$Contamination)

ggplot(data = ST_ON_Analysis_Log,aes(x=Log))+
  geom_histogram(colour="black", alpha=.2,bins = 10)+
  scale_x_continuous(n.breaks = 10)+
  xlab("Contamination log GEC/Item")+
  ylab("Density")+
  ggtitle("Density Curves Interventions")+ 
  theme(plot.title = element_text(hjust = 0.5))


```

```{r}
ST_ON_Analysis$Category<-""
ST_ON_Analysis$OnOff<-"ON"

for (i in 1:nrow(ST_ON_Analysis)){
  Conta<-as.numeric(ST_ON_Analysis$Contamination[i])
  if(Conta == 0 ){
    ST_ON_Analysis$Category[i] <-"0"
  } else if(Conta >0 && Conta< 100 ){
    ST_ON_Analysis$Category[i]  <-"<0 - 100"
  }else if(Conta > 100 && Conta < 1000 ){
    ST_ON_Analysis$Category[i]  <-"100 - 1000"
  }else if(Conta > 1000 ){
    ST_ON_Analysis$Category[i]  <-">1000"
  }
}



PlotOrder<-c("0","<0 - 100","100 - 1000",">1000")

ST_ON_Analysis %>% 
  count(Category) %>% 
  mutate(perc = n / nrow(ST_ON_Analysis)) %>%
  slice(match(Category,PlotOrder))-> tips2

tips2$OnOff<-"ON"



ggplot(data =tips2, aes(x = OnOff,y=perc, fill=factor(Category, levels=c("0","<0 - 100","100 - 1000",">1000"))))+
  geom_col(width = .1)+
  geom_text_repel(aes(x = OnOff, 
                      y = perc, 
                      label = paste(round(perc*100,2),"%")),nudge_y = -.2, nudge_x = .25, direction = "y")+
  labs(fill = "Category")+
  scale_x_discrete(expand = c(.3, 0))

```



