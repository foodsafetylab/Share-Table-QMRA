#Changing Data Frame so it updates when student consumes fruit.
if(Pick_ST_YN_Pss==1){
if(Eat_YN_ST_Pss==1){
Pss_Data.Frame[Pss_ST_Picked,colnames(Pss_Data.Frame)== "Location"]<-"Consumed"
Pss_Data.Frame[Pss_ST_Picked,colnames(Pss_Data.Frame)=="History"]<-paste(Pss_Data.Frame[Pss_ST_Picked,colnames(Pss_Data.Frame)=="History"], "Consumed")
}else{
Pss_Data.Frame[Pss_ST_Picked,colnames(Pss_Data.Frame)== "Location"]<-"Not Consumed"
Pss_Data.Frame[Pss_ST_Picked,colnames(Pss_Data.Frame)=="History"]<-paste(Pss_Data.Frame[Pss_ST_Picked,colnames(Pss_Data.Frame)=="History"], "NotConsumed")
}
}
}
#Shared Pre
Items_Shared_Pre<-Pre_Data.Frame$Location == "Shared"
Sum_Shared_Pre<-sum(Items_Shared_Pre)
if(Sum_Shared_Pre>0){
#Did a student pick an item for the share table?
Pick_ST_YN_Pre<-ifelse(runif(1)<Pr_Pick_ST_Pre,1,0)
#Pre picked from Share Table.
if(Pick_ST_YN_Pre==1){
Search.df.Pre_ST<-Func_Search_Data(Pre_Data.Frame,Pre_Data.Frame$Location,"Shared",1)
#Pre from share table selected #
Pre_ST_Picked<-as.numeric(Search.df.Pre_ST$Pre.No.)
Pre_Data.Frame[as.numeric(row.names(Search.df.Pre_ST)),colnames(Search.df.Pre)== "Location"]<-"Tray"
Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)=="History"]<-paste(Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)=="History"], "Tray")
}
#Contamination from Hand to Fruit or from Hand to Fruit.
if(Pick_ST_YN_Pre==1){
#Contamination at tray
Cont_Tray_Pre<- Func_Index_DF(Pre_Data.Frame,Pre_ST_Picked,"Contamination") + Tr_H_Pre - (Func_Index_DF(Pre_Data.Frame,Pre_ST_Picked,"Contamination")* TE_F_H)
#Add contamination to chosen fruit in Dataframe
Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)== "Contamination"]<-Cont_Tray_Pre
}
#Consumption of share table item
#Did the student consume the Fruit?
Eat_YN_ST_Pre<-ifelse(runif(1)<Pr_eat_ST_Pre,1,0)
#Changing Data Frame so it updates when student consumes fruit.
if(Pick_ST_YN_Pre==1){
if(Eat_YN_ST_Pre==1){
Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)== "Location"]<-"Consumed"
Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)=="History"]<-paste(Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)=="History"], "Consumed")
}else{
Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)== "Location"]<-"Not Consumed"
Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)=="History"]<-paste(Pre_Data.Frame[Pre_ST_Picked,colnames(Pre_Data.Frame)=="History"], "NotConsumed")
}
}
}#end of if there is st items loop
}#end of toggle loop
}  #end of first loop
#Updated items from not consumed, not shared, etc to wasted.
Fr_Data.Frame$Location[Fr_Data.Frame$Location=="Not Shared"]<-"Discarded"
Fr_Data.Frame$Location[Fr_Data.Frame$Location=="Not Consumed"]<-"Discarded"
if(Reservice_YN==0){
Fr_Data.Frame$Location[Fr_Data.Frame$Location=="Selection Table"]<-"Discarded"
}
if(Resharing_YN==0){
Fr_Data.Frame$Location[Fr_Data.Frame$Location=="Shared"]<-"Discarded"
}
Pss_Data.Frame$Location[Pss_Data.Frame$Location=="Not Shared"]<-"Discarded"
Pss_Data.Frame$Location[Pss_Data.Frame$Location=="Not Consumed"]<-"Discarded"
if(Reservice_YN==0){
Pss_Data.Frame$Location[Pss_Data.Frame$Location=="Selection Table"]<-"Discarded"
}
if(Resharing_YN==0){
Pss_Data.Frame$Location[Pss_Data.Frame$Location=="Shared"]<-"Discarded"
}
Pre_Data.Frame$Location[Pre_Data.Frame$Location=="Not Shared"]<-"Discarded"
Pre_Data.Frame$Location[Pre_Data.Frame$Location=="Not Consumed"]<-"Discarded"
if(Reservice_YN==0){
Pre_Data.Frame$Location[Pre_Data.Frame$Location=="Selection Table"]<-"Discarded"
}
if(Resharing_YN==0){
Pre_Data.Frame$Location[Pre_Data.Frame$Location=="Shared"]<-"Discarded"
}
#Adding the data to the loop
datalistFr[[j]]<-Fr_Data.Frame
datalistPss[[j]]<-Pss_Data.Frame
datalistPre[[j]]<-Pre_Data.Frame
source("OutputsV5.R")
message("Service #", j)
} #end of second loop
#Creation of the Final Data Frames
Fr_Data = do.call(rbind,datalistFr)
Pss_Data = do.call(rbind,datalistPss)
Pre_Data = do.call(rbind,datalistPre)
#Visuals
source("VisualsV5.R")
source("VisualsV5.R")
source("VisualsV5.R")
Location_BarC_Function<-function(Data, Title){
ggplot(Data, aes(x=Service, fill=Location)) +
stat_count()+theme_minimal()+
scale_x_continuous(breaks = seq(1,Meal_Day, by = 1))+
ggtitle(Title)+
theme(plot.title = element_text(hjust = 0.5))
}
if(Resharing_YN==0)
Location_BarC_Function(Fr_Data,"Fruit Location Re-Service & Re-Sharing off")
#Critical Functions####
ShelfLife <- function( Nmax = 10^7.8, N0 = 5 , mumax = 0.054, ...) {
#predict shelf life as a fucntion of:
#Nmax: Max SSO count     [CFU/g]  ; reference average was 10^7.9; FSSP seems to use 10^7.8
#N0:   Inital SSO count  [CFU/)]  ; reference showed graphs as high as ~1.5
#mumax:Max growth rate   [log10(CFU/g)/h]; reference range has high as 0.076
#N0 <- 10^N0
#Nmax <- 10^Nmax
shelf_life <- ( 4 * log(2) + log( (Nmax / N0) - 1 ) ) / mumax
return(shelf_life)
}
MuMax <- function( T = 2 , pH = 6.2, uref = 0.583, Tref = 25, Tmin = -5.246,
pHmin = 4.24, CO2max = 6691, GPr = 2,...) {
#predict max growth [log10(CFU/g)/h] rate as a function of
#T:   Temperature [C], range (0-15C)
#CO2: equilibrium CO2 [%], range 0-100%
#pH:  estimated pH of products
#all constants are from paper
CO2dis <- getCO2diseq(T = T)
MuMax <- uref * ( (T-Tmin)/(Tref-Tmin) )^2 * ( 1-10^(pHmin-pH) ) * ( (CO2max-CO2dis)/CO2max )
#print(paste("T param", ((T-Tmin)/(Tref-Tmin) )^2))
#print(paste("pH param", ( 1-10^(pHmin-pH) ) ))
#print(paste("CO2 param", ( (CO2max-CO2dis)/CO2max ), "CO2 dis", CO2dis) )
return(MuMax)
}
#Critical Functions####
ShelfLife <- function( Nmax = 10^7.8, N0 = 5 , mumax = 0.054, ...) {
#predict shelf life as a fucntion of:
#Nmax: Max SSO count     [CFU/g]  ; reference average was 10^7.9; FSSP seems to use 10^7.8
#N0:   Inital SSO count  [CFU/)]  ; reference showed graphs as high as ~1.5
#mumax:Max growth rate   [log10(CFU/g)/h]; reference range has high as 0.076
#N0 <- 10^N0
#Nmax <- 10^Nmax
shelf_life <- ( 4 * log(2) + log( (Nmax / N0) - 1 ) ) / mumax
return(shelf_life)
}
MuMax <- function( T = 2 , pH = 6.2, uref = 0.583, Tref = 25, Tmin = -5.246,
pHmin = 4.24, CO2max = 6691, GPr = 2,...) {
#predict max growth [log10(CFU/g)/h] rate as a function of
#T:   Temperature [C], range (0-15C)
#CO2: equilibrium CO2 [%], range 0-100%
#pH:  estimated pH of products
#all constants are from paper
CO2dis <- getCO2diseq(T = T)
MuMax <- uref * ( (T-Tmin)/(Tref-Tmin) )^2 * ( 1-10^(pHmin-pH) ) * ( (CO2max-CO2dis)/CO2max )
#print(paste("T param", ((T-Tmin)/(Tref-Tmin) )^2))
#print(paste("pH param", ( 1-10^(pHmin-pH) ) ))
#print(paste("CO2 param", ( (CO2max-CO2dis)/CO2max ), "CO2 dis", CO2dis) )
return(MuMax)
}
getCO2diseq <- function(T = 0, ...){
#importing equilibrium CO2 from FSSP, valid 0-10C
#only for 70% CO2 inital fill
Temp <- 0:10
CO2eq <- c(1630.31,	1596.2,	1562.33,	1528.75,	1495.53,	1462.7,	1430.32,	1308.43,	1367.06,	1336.23,	1305.99)
if(T == last(Temp)) {
CO2eq <- last(CO2eq)
} else {
i <- sum(Temp <= T)
CO2eq <- CO2eq[i] + (CO2eq[i+1]-CO2eq[i]) * (T-Temp[i]) / (Temp[i+1]-Temp[i])
}
return(CO2eq)
}
interpoloate <- function( xt, x0, x1, y0, y1){ y0 + (y1-y0) * (xt-x0) / (x1-x0) }
getlogNt <- function(Nmax = 8.5, N0 = 3, mu = 0.03, t=1, ...) {
nt <- log(   10^Nmax / (  1 + ((10^Nmax / 10^N0 - 1) * exp(-mu*t))  )   )
return(log10(exp(nt)))
}
getGthCurve <- function(p, N0 = 1, Nmax = 7.8, ...) {
p$logN <- N0
for (i in 2:dim(p)[1] ) {
#loop through the parameters
#co2 <- getCO2diseq(T=p$T[i])
mu = MuMax(T=p$T[i])
p$logN[i] <- getlogNt(t=p$t[i]-p$t[i-1], mu = mu, N0 = p$logN[i-1], Nmax = Nmax)
}
return(p)
}
getShelfLife <- function(p, Nspoil = 7, detailed = F , ...){
#get spoilage by time to Nmax
i <- sum( p$logN < Nspoil )
tspoil <- interpoloate(Nspoil, x0 = p$logN[i], x1 = p$logN[i+1], y0 = p$t[i], y1 = p$t[i+1])
if(detailed) print(paste("shelf life", tspoil, "hours"))
return(tspoil)
}
ShelfLifeFromTofT <- function(p, N0 = 3, Nmax = 8.5,  Nspoil = 7, detailed = F, ...){
p <- getGthCurve(p, N0 = N0, Nmax = Nmax)
sl <- getShelfLife(p, Nspoil = Nspoil, detailed = detailed)
if(is.na(sl)) {
iend <- dim(p)[1]
#print(iend)
nadd <- length(last(p$t +1):500)
#print(nadd)
#print(1:nadd + iend)
#print((last(p$t)+1):500)
p[ 1:nadd + iend , 1:2 ] <- cbind( (last(p$t)+1):500, last(p$T))
p <- getGthCurve(p, N0 = N0, Nmax = Nmax)
sl <- getShelfLife(p, Nspoil = Nspoil, detailed = detailed)
print(paste("Product will not have spoiled, will spoil in", sl, "total hours"))
}
pl <- ggplot(data = p, aes(x=t)) + geom_point(aes(y=logN)) + geom_line(aes(y=T), color="blue") +
theme_bw() + labs(title=paste("Shelf Life of ", round(sl/24, 2),"d. Predicted for 70% CO2 at 2X Gas to Product, N0 =", N0 ,"log(CFU/g)"),
x = "Time [h]", y = "Spoilage Count [log10(CFU/g) or Temperature [C]") + geom_vline(xintercept = sl, color = "red")
if(detailed) plot(pl)
return(sl/24)
}
#these are things to put in as a source call
source("PoultryModelFunctions-v9-21-18.R")
d <- data.frame( t = (0:30)*24, T = 2 )
View(d)
#New Try
setwd("C:/Users/reyes/Documents/GitHub/Share-Table-QMRA")
#Inputs:
RelativeLag<-0 #we have to reset this after every iteration.
InitialCon<- 2.3 #CFU/g
Time_ST<-6
Time_StorageST<-.2
Time_Selection<-2.4
Time_Consumption<-.5
Temp_ST<-25
Temp_StorageST<-4
Temp_Selection<-25
Temp_Consumption<-25
Growth_Data<-read.csv("Growth Table.csv")
#Selection Table
GrowthModel<-Func_seach_Data4(Growth_Data,Growth_Data$Temperature,Temp_Selection,1)
Growth_rate<-GrowthModel$Growth.Rate
LagLength<-GrowthModel$Lag.Phase
Nmax<-GrowthModel$Nmax
RelativeLag<-Time_Selection/LagLength + RelativeLag
if(RelativeLag>1){
InitialCon<-(Time_Selection-LagLength)*Growth_rate+InitialCon
}
#Share Table
GrowthModel<-Func_seach_Data4(Growth_Data,Growth_Data$Temperature,Temp_ST,1)
Growth_rate<-GrowthModel$Growth.Rate
LagLength<-GrowthModel$Lag.Phase
Nmax<-GrowthModel$Nmax
RelativeLag<-Time_ST/LagLength + RelativeLag
if(RelativeLag>1){
InitialCon<-((Time_ST-LagLength)*Growth_rate)+InitialCon
}
if(InitialCon>=Nmax){
InitialCon = Nmax
}
#New Try
setwd("C:/Users/reyes/Documents/GitHub/Share-Table-QMRA")
source("FunctionsV6.r")
#Inputs:
RelativeLag<-0 #we have to reset this after every iteration.
InitialCon<- 2.3 #CFU/g
Time_ST<-6
Time_StorageST<-.2
Time_Selection<-2.4
Time_Consumption<-.5
Temp_ST<-25
Temp_StorageST<-4
Temp_Selection<-25
Temp_Consumption<-25
Growth_Data<-read.csv("Growth Table.csv")
#Selection Table
GrowthModel<-Func_seach_Data4(Growth_Data,Growth_Data$Temperature,Temp_Selection,1)
Growth_rate<-GrowthModel$Growth.Rate
LagLength<-GrowthModel$Lag.Phase
Nmax<-GrowthModel$Nmax
RelativeLag<-Time_Selection/LagLength + RelativeLag
if(RelativeLag>1){
InitialCon<-(Time_Selection-LagLength)*Growth_rate+InitialCon
}
#Share Table
GrowthModel<-Func_seach_Data4(Growth_Data,Growth_Data$Temperature,Temp_ST,1)
Growth_rate<-GrowthModel$Growth.Rate
LagLength<-GrowthModel$Lag.Phase
Nmax<-GrowthModel$Nmax
RelativeLag<-Time_ST/LagLength + RelativeLag
if(RelativeLag>1){
InitialCon<-((Time_ST-LagLength)*Growth_rate)+InitialCon
}
if(InitialCon>=Nmax){
InitialCon = Nmax
}
library(dplyr)
RelativeLag<-0 #we have to reset this after every iteration.
InitialCon<- 2.3 #CFU/g
Time_ST<-6
Time_StorageST<-.2
Time_Selection<-2.4
Time_Consumption<-.5
Temp_ST<-25
Temp_StorageST<-4
Temp_Selection<-25
Temp_Consumption<-25
Growth_Data<-read.csv("Growth Table.csv")
GrowthModel<-Func_seach_Data4(Growth_Data,Growth_Data$Temperature,Temp_Selection,1)
Growth_rate<-GrowthModel$Growth.Rate
LagLength<-GrowthModel$Lag.Phase
Nmax<-GrowthModel$Nmax
RelativeLag<-Time_Selection/LagLength + RelativeLag
if(RelativeLag>1){
InitialCon<-(Time_Selection-LagLength)*Growth_rate+InitialCon
}
GrowthModel<-Func_seach_Data4(Growth_Data,Growth_Data$Temperature,Temp_ST,1)
Growth_rate<-GrowthModel$Growth.Rate
LagLength<-GrowthModel$Lag.Phase
Nmax<-GrowthModel$Nmax
RelativeLag<-Time_ST/LagLength + RelativeLag
if(RelativeLag>1){
InitialCon<-((Time_ST-LagLength)*Growth_rate)+InitialCon
}
if(InitialCon>=Nmax){
InitialCon = Nmax
}
N<-5
b<-.02
T<-15
Tmin<-(-.06)
rate<-b(T-Tmin)
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(dN.dt))
}
p<-c(rate)
t<-0:100
N<-5
b<-.02
T<-15
Tmin<-(-.06)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(dN.dt))
}
p<-c(rate)
t<-0:100
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
library(deSolve)
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
N<-5
N<-5
b<-.02
T<-15
Tmin<-(-.06)
rate<-b*(T-Tmin)^2
N<-0
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-0:100
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
N<-.5
b<-.02
T<-15
Tmin<-(-.06)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-0:100
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
N<-3.2
b<-.02
T<-15
Tmin<-(-.06)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-0:100
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
View(sol)
N<-3.2
b<-.02
T<-4
Tmin<-(-.06)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-0:100
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
View(sol)
N<-3.2
b<-.02
T<-4
Tmin<-(-.6)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-0:100
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
View(sol)
N<-3.2
b<-.02
T<-4
Tmin<-(-.6)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-seq(0:2, by=.1)
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
N<-3.2
b<-.02
T<-4
Tmin<-(-.6)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-seq(0,2, by=.1)
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
N<-3.2
b<-.02
T<-25
Tmin<-(-.6)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-seq(0,2, by=.1)
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
View(sol)
N<-3.2
b<-.02
T<-8
Tmin<-(-.6)
rate<-b*(T-Tmin)^2
Growth_Sal<-function(times,y,params){
DNt.dt<-p[1]*y[1]
return(list(DNt.dt))
}
p<-c(rate)
t<-seq(0,2, by=.1)
sol<-ode(y=N, times = t , func = Growth_Sal, parms = p)
plot(t,sol[,2])
library(deSolve)
library(brms)
N<-3.5
#Initial Contamination Log CFU/g
b<-.023
# Temperature coefficient from McKellar and Delaquis
k<-rnorm(1,.013,.001)/2.303
T<-12
#Temperature in °C
Tmin<-(1.17)
#Minimum growth temperature
rate<-(b*(T-Tmin))^2/2.303
#Growth rate equation from Ratkowsky, coonverted to LOG CFU-1 h-1
Time<-300
#Time in hours
#Growth
Con_Change<-rate*Time
#Change in contamination over the time period
Con_Final<-Con_Change + N
#Final contamination
#Die Off
Die_off<-(-k)*Time
data2<- data.frame(
Time = 1:Time,
Change = "",
stringsAsFactors = FALSE
)
for (i in 1:nrow(data)){
Con_Change<-rate*i
data$Change[i]<-Con_Change
}
plot(data$Time,data$Change)
plot(data2$Time,data$Change)
View(data2)
data<- data.frame(
Time = 1:Time,
Change = "",
stringsAsFactors = FALSE
)
for (i in 1:nrow(data)){
Con_Change<-rate*i
data$Change[i]<-Con_Change
}
plot(data$Time,data$Change)
#Data frame for representation (Validation of the McKellar and Delaquis FIG 7b:
data2<- data.frame(
Time = 1:Time,
Change = "",
stringsAsFactors = FALSE
)
for (i in 1:nrow(data)){
Die_off<-(-k)*i
data$Change[i]<-Die_off
}
plot(data$Time,data$Change)
